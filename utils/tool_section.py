"""
목차(소제목) 생성 전용 도구 모듈
- test_report.py 및 기타 보고서 생성에서 사용
"""

import re

def write_section_titles_prompt(question: str, context: str) -> str:
    """
    질문과 context를 바탕으로, 서로 겹치지 않는 소제목 3개만 한 줄씩 출력하는 프롬프트 반환
    """
    return f"""
반드시 모든 답변을 한국어로 작성하세요.
아래는 사용자의 질문과 임베딩 기반 참고 문서입니다. 두 가지 모두를 깊이 있게 참고하여, 질문에 가장 적합한 소제목 3개를 선정하세요.

- 소제목은 서로 겹치지 않는 독립적 주제여야 하며, 질문과 직접적으로 연관되어야 합니다.
- 소제목은 반드시 한 줄에 하나씩, 총 3줄로만 출력하세요. (설명, 번호, 마크다운, 부연설명, 서론/결론 등은 절대 포함하지 마세요)
- 반드시 실제 소제목만 대괄호로 감싸서 사용하세요.
- 3번째 소제목은 반드시 '{question}'(와/과) 관련된 인허가 절차, 행정 절차, 법적 요건, 신고/등록/승인 등 제도적 절차를 다루는 주제로 작성하세요.
- 소제목 선정 안내, 예시, 영어 안내문, 설명 등은 절대 쓰지 마세요.

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

def fix_section_markers(text, section_titles):
    # [소제목1], [ 소제목1 ], [ 소제목1 ] 등 모든 변형 치환, 대괄호 여러 개 → 한 쌍으로 통일
    for i, t in enumerate(section_titles, 1):
        # 대괄호 여러 개, 공백 포함, 숫자 뒤에도 공백 허용
        text = re.sub(rf"\[+\s*소제목\s*{i}\s*\]+", f"[{t}]", text)