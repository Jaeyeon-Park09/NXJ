"""
전문적이고 상세한 단일 보고서(섹션 없이) 생성을 위한 프롬프트 및 도구 모듈
- test_report.py 전용
- 임베딩 기반 문장에는 본문 내 괄호 출처 표기 지침 포함
"""
from datetime import datetime
from langchain_core.tools import BaseTool

# 단일 보고서(섹션 없음)용 프롬프트 템플릿
DETAILED_REPORT_INSTRUCTIONS = """
반드시 모든 답변을 한국어로 작성하세요. 영어, 번역투, 불명확한 표현을 쓰지 마세요.

아래는 사용자의 질문과 임베딩 기반 참고 문서입니다. 두 가지 모두를 깊이 있게 참고하여, 질문에 가장 적합한 보고서를 논리적이고 일관성 있게 작성하세요.

<목차 및 구조 지침>
- 글 전체를 관통하는 대표 소주제(소제목) 3개를 반드시 선정하세요. 글 앞부분에 [목차] 마커 아래에 목차(소제목 3개)를 먼저 제시하세요.
- 목차는 반드시 아래 예시처럼, '서론', 소제목 3개, '결론' 순서로, 한 줄에 하나씩, 마크다운 없이 출력하세요.
- 목차 출력 예시:
[목차]
서론
소제목1
소제목2
소제목3
결론

- 목차 제시 후, 반드시 빈 줄 2회 후 [본문 시작] 마커를 새 줄에 단독으로 작성하세요.
- [본문 시작] 아래에 서론, 소제목 3개, 결론 본문을 순서대로 작성하세요.
- 서론 제목은 반드시 마크다운 형식의 '# 제목'으로, 단독 줄에 작성하세요. 본문과 붙지 않게 하세요.
- 결론 제목은 반드시 '## 결론'으로, 단독 줄에 작성하세요.
- 각 소제목(섹션)은 중복되지 않는 독립적 주제를 가져야 하며, 메인 주제와 직접적으로 연관되어야 합니다.
- 연관된 개념은 하나로 합치고, 불필요하게 나누지 마세요.
- 구조에 중복이 없는지, 논리적 흐름이 자연스러운지 반드시 검토하세요.

<본문 작성 지침>
- 답변을 작성하기 전에, 질문과 참고 문서를 모두 꼼꼼히 읽고, 글 전체의 맥락과 핵심 주제를 파악하세요.
- 각 소제목(섹션)마다 새로운 정보, 관점, 세부 내용을 중심으로 작성하세요.
- 각 소제목(섹션) 본문은 반드시 300자 이상, 서론과 결론은 150~200자로 작성하세요.
- 동일하거나 유사한 내용을 두 번 이상 반복하지 마세요.
- 서로 다른 소제목(섹션) 간에 중복되는 내용이 없도록 하세요.
- 중복 문장, 의미 없는 반복, 불필요한 요약은 피하세요.
- 임베딩 참고 문서의 문장은 최대한 수정하지 말고, 그대로 인용·활용하세요. 불가피하게 수정할 경우, 의미를 바꾸지 말고 최소한의 수정만 허용하세요.
- 논리적 흐름과 체계적 구조를 갖추되, 소제목 외의 추가 섹션 구분, 목차, 참고문헌, 부록 등은 작성하지 마세요.
- 전체 글이 자연스럽게 이어지도록, 하나의 글처럼 서술하세요.

<서론 작성 지침>
- 제목에 # 사용(마크다운)
- 100자 이상, 쉽고 명확한 언어로 서술하세요.
- 2~3단락에 걸쳐, 글의 동기와 주요 내용을 자연스럽게 파악하며 읽기 시작할 수 있도록 소개하세요.
- 전체 글의 흐름을 명확히 제시하세요.
- 소스 목록, 리스트, 표 등 구조적 요소 사용 금지

<결론 작성 지침>
- 제목에 ## 결론 사용(마크다운)
- 150~200자 이내
- 본문에서 다룬 핵심 주제, 결과, 인사이트를 간결하게 정리
- 구체적 예시나 데이터, 향후 조치/시사점 포함
- 소스 목록, 불필요한 구조적 요소 사용 금지

<작성 원칙>
- 구체적 세부사항 위주로, 군더더기 없이 핵심만 표현
- 각 섹션의 가장 중요한 포인트에 집중
- 전체적으로 논리적, 일관성 있는 흐름 유지

<작성 완료 후 검증>
- [목차] 마커 아래에 서론, 소제목3개, 결론 순서로 한 줄씩, 총 5줄로 목차가 제시되어야 함
- 목차와 본문 사이 빈 줄 2회, [본문 시작] 마커가 단독 줄에 있어야 함
- 각 소제목 본문은 300자 이상, 결론은 150~200자
- 마크다운 형식
- 응답에 워드카운트/서문 넣지 말 것

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

def write_section_titles_prompt(question: str, context: str) -> str:
    """
    목차(소제목 3개) 선정 프롬프트 반환
    """
    return f"""
반드시 모든 답변을 한국어로 작성하세요.
아래는 사용자의 질문과 임베딩 기반 참고 문서입니다.

- 글 전체를 관통하는 대표 소주제(소제목) 3개를 반드시 선정하세요.
- 소제목은 서로 중복되지 않는 독립적 주제로, 메인 주제와 직접적으로 연관되어야 합니다.
- 소제목 선정 안내, 영어, 불필요한 설명 없이, 소제목 3개만 한 줄씩 출력하세요.

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

def write_intro_prompt(question: str, context: str) -> str:
    """
    서론 생성 프롬프트 반환
    """
    return f"""
반드시 모든 답변을 한국어로 작성하세요.
아래는 사용자의 질문과 임베딩 기반 참고 문서입니다.

- 서론은 100자 이상, 쉽고 명확한 언어로 2~3단락에 걸쳐 작성하세요.
- 글의 동기와 주요 내용을 자연스럽게 소개하고, 전체 흐름을 명확히 제시하세요.
- 안내문, 소스 목록, 리스트, 표 등 구조적 요소는 사용하지 마세요.
- (출처: ~) 표기는 쓰지 마세요.

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

def write_section_body_prompt(question: str, context: str, section_title: str, all_section_titles: list[str] = []) -> str:
    """
    본문(소제목별) 생성 프롬프트 반환 (다른 소제목과의 차별성 강조)
    """
    return f"""
반드시 모든 답변을 한국어로 작성하세요.
아래는 사용자의 질문, 임베딩 기반 참고 문서, 그리고 소제목입니다.

- 반드시 소제목 '{section_title}'에 해당하는 내용만 집중적으로 작성하세요.
- 다른 소제목과 중복/반복 없이, 이 소제목에만 집중해서 작성하세요.
- 본문은 100자 이상, 안내문/예고문 없이 구체적으로 작성하세요.
- (출처: ~) 표기는 쓰지 마세요.

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

def write_conclusion_prompt(question: str, context: str) -> str:
    """
    결론 생성 프롬프트 반환
    """
    return f"""
반드시 모든 답변을 한국어로 작성하세요.
아래는 사용자의 질문과 임베딩 기반 참고 문서입니다.

- 결론은 100자 이상, 본문에서 다룬 핵심 주제와 인사이트를 간결하게 정리하세요.
- 구체적 예시나 데이터, 향후 조치/시사점이 있으면 포함하세요.
- (출처: ~) 표기는 쓰지 마세요.

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

def write_detailed_report(question: str, context: str) -> str:
    """
    전문적이고 상세한 단일 보고서 작성 프롬프트 반환 (출처 표기 지침 포함)
    """
    return DETAILED_REPORT_INSTRUCTIONS.format(
        question=question,
        context=context
    )

def write_body_sections_prompt(question: str, context: str, section_titles: list[str]) -> str:
    """
    소제목 3개를 변수로 받아, 각 본문만 마커로 구분해 생성하도록 유도하는 프롬프트 반환
    """
    # 실제 소제목 이름을 마커로 사용
    sec1, sec2, sec3 = section_titles
    return f"""
반드시 모든 답변을 한국어로 작성하세요.
아래는 사용자의 질문, 임베딩 기반 참고 문서, 그리고 이미 선정된 소제목 3개입니다.

각 문단의 제목은 출력하지 말고, 아래 마커([서론], [{sec1}], [{sec2}], [{sec3}], [결론])로 구분하여 본문만 작성하세요.

!!! 반드시 아래 실제 소제목 이름을 대괄호로 감싸서 마커로 사용하세요. 반드시 예시를 따르지 말고, 안내문, 영어, 소제목 선정 안내 등은 절대 쓰지 마세요. !!!

- [서론] 아래: 서론 본문 (250자 이상)
- {sec1} 아래: 소제목1 본문 (250자 이상)
- {sec2} 아래: 소제목2 본문 (250자 이상)
- {sec3} 아래: 소제목3 본문 (250자 이상)
- [결론] 아래: 결론 본문 (250자 이상)

아래 소제목 3개를 반드시 그대로 사용해 본문을 작성하세요:
{sec1}\n{sec2}\n{sec3}

<질문>
{question}
</질문>

<임베딩 기반 참고 문서>
{context}
</임베딩 기반 참고 문서>
"""

class DetailedReportGenTool(BaseTool):
    name: str = "detailed_report_generation"
    description: str = "질문과 임베딩 기반 context를 바탕으로, 전문적이고 상세한 단일 보고서를 생성합니다. (본문 내 출처 표기 포함)"

    def _run(self, question: str, context: str = "") -> str:
        return write_detailed_report(question, context)

    async def _arun(self, question: str, context: str = "") -> str:
        return self._run(question, context) 